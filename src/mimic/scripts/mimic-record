#!/bin/bash
# Mimic Robot Recording Wrapper Script

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/../config/robot_config.yaml"

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Configuration file not found: $CONFIG_FILE"
    exit 1
fi

# Default values (can be overridden by command line)
NUM_EPISODES=""
EPISODE_TIME=""
RESET_TIME=""
TASK_DESC=""
REPO_ID=""

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --episodes)
            NUM_EPISODES="$2"
            shift 2
            ;;
        --episode-time)
            EPISODE_TIME="$2"
            shift 2
            ;;
        --reset-time)
            RESET_TIME="$2"
            shift 2
            ;;
        --task)
            TASK_DESC="$2"
            shift 2
            ;;
        --repo)
            REPO_ID="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: mimic-record [--episodes N] [--episode-time S] [--reset-time S] [--task \"description\"] [--repo repo_id]"
            exit 1
            ;;
    esac
done

# Parse YAML config
parse_yaml() {
    python3 -c "
import yaml
import json

with open('$CONFIG_FILE', 'r') as f:
    config = yaml.safe_load(f)

robot = config['robot']
teleop = config['teleop']
dataset = config['dataset']
recording = dataset['recording']

# Use command line args if provided, otherwise use config
episodes = '$NUM_EPISODES' if '$NUM_EPISODES' else str(recording['num_episodes'])
episode_time = '$EPISODE_TIME' if '$EPISODE_TIME' else str(recording['episode_time_s'])
reset_time = '$RESET_TIME' if '$RESET_TIME' else str(recording['reset_time_s'])
task = '$TASK_DESC' if '$TASK_DESC' else recording['single_task']
repo_id = '$REPO_ID' if '$REPO_ID' else dataset['repo_id']

cameras = json.dumps(robot['cameras'])

print(f'CAMERAS={cameras}')
print(f'ROBOT_TYPE={robot[\"type\"]}')
print(f'ROBOT_ID={robot[\"id\"]}')
print(f'ROBOT_LEFT_ARM={robot[\"left_arm_port\"]}')
print(f'ROBOT_RIGHT_ARM={robot[\"right_arm_port\"]}')
print(f'ROBOT_BASE={robot[\"base_port\"]}')
print(f'TELEOP_TYPE={teleop[\"type\"]}')
print(f'TELEOP_ID={teleop[\"id\"]}')
print(f'TELEOP_LEFT_ARM={teleop[\"left_arm_port\"]}')
print(f'TELEOP_RIGHT_ARM={teleop[\"right_arm_port\"]}')
print(f'TELEOP_BASE_MODE={teleop[\"base_control_mode\"]}')
print(f'DISPLAY_DATA={str(config[\"display_data\"]).lower()}')
print(f'REPO_ID={repo_id}')
print(f'NUM_EPISODES={episodes}')
print(f'EPISODE_TIME={episode_time}')
print(f'RESET_TIME={reset_time}')
print(f'TASK_DESC={task}')
print(f'FPS={dataset[\"fps\"]}')
print(f'NUM_WRITERS={dataset[\"num_image_writer_processes\"]}')
print(f'VIDEO={str(dataset[\"video\"]).lower()}')
"
}

# Get config values
eval "$(parse_yaml)"

# Build command
CMD="lerobot-record \
  --robot.type=$ROBOT_TYPE \
  --robot.left_arm_port=$ROBOT_LEFT_ARM \
  --robot.right_arm_port=$ROBOT_RIGHT_ARM \
  --robot.base_port=$ROBOT_BASE \
  --robot.id=$ROBOT_ID \
  --robot.cameras='$CAMERAS' \
  --teleop.type=$TELEOP_TYPE \
  --teleop.left_arm_port=$TELEOP_LEFT_ARM \
  --teleop.right_arm_port=$TELEOP_RIGHT_ARM \
  --teleop.base_control_mode=$TELEOP_BASE_MODE \
  --teleop.id=$TELEOP_ID \
  --dataset.repo_id=$REPO_ID \
  --dataset.single_task=\"$TASK_DESC\" \
  --dataset.num_episodes=$NUM_EPISODES \
  --dataset.episode_time_s=$EPISODE_TIME \
  --dataset.reset_time_s=$RESET_TIME \
  --dataset.num_image_writer_processes=$NUM_WRITERS \
  --dataset.video=$VIDEO \
  --dataset.fps=$FPS \
  --display_data=$DISPLAY_DATA"

echo "Running: lerobot-record ..."
echo "  Episodes: $NUM_EPISODES"
echo "  Episode time: ${EPISODE_TIME}s"
echo "  Task: $TASK_DESC"
echo ""
eval "$CMD"
