#!/bin/bash
# Mimic Robot Dataset Replay Wrapper Script
# Uses robot_config.yaml for consistent configuration

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/../../src/mimic/config/robot_config.yaml"

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Configuration file not found: $CONFIG_FILE"
    echo "Expected: $CONFIG_FILE"
    exit 1
fi

# Check required arguments (repo_id and episode are required, root is optional)
REPO_ID=""
EPISODE=""
for arg in "$@"; do
    if [[ "$arg" == --dataset.repo_id=* ]]; then
        REPO_ID="${arg#*=}"
    fi
    if [[ "$arg" == --dataset.episode=* ]]; then
        EPISODE="${arg#*=}"
    fi
done

if [ -z "$REPO_ID" ] || [ -z "$EPISODE" ]; then
    echo "Usage: $0 --dataset.repo_id=<repo_id> --dataset.episode=<episode_num> [--dataset.root=<root_path>] [additional args]"
    echo ""
    echo "Examples:"
    echo ""
    echo "  # Load from HuggingFace Hub:"
    echo "  $0 \\"
    echo "    --dataset.repo_id=ac-pate/test_mobile_bimanual_converted \\"
    echo "    --dataset.episode=0"
    echo ""
    echo "  # Load from local directory:"
    echo "  $0 \\"
    echo "    --dataset.repo_id=bimanual_blue_block_handover_1 \\"
    echo "    --dataset.root=/tmp/dataset_conversion_cvqdnpvv/Mimic-Robotics \\"
    echo "    --dataset.episode=0"
    exit 1
fi

# Parse YAML config
TEMP_CONFIG=$(mktemp)
python3 << PYEOF > "$TEMP_CONFIG"
import yaml

with open('$CONFIG_FILE', 'r') as f:
    config = yaml.safe_load(f)

robot = config['robot']

# Write robot config as KEY=VALUE pairs
print(f'ROBOT_TYPE="{robot["type"]}"')
print(f'ROBOT_ID="{robot["id"]}"')
print(f'ROBOT_LEFT_ARM="{robot["left_arm_port"]}"')
print(f'ROBOT_RIGHT_ARM="{robot["right_arm_port"]}"')
print(f'ROBOT_BASE="{robot["base_port"]}"')
PYEOF

# Get config values
source "$TEMP_CONFIG"
rm "$TEMP_CONFIG"

# Build command with robot config from YAML
CMD="lerobot-replay \
  --robot.type=$ROBOT_TYPE \
  --robot.left_arm_port=$ROBOT_LEFT_ARM \
  --robot.right_arm_port=$ROBOT_RIGHT_ARM \
  --robot.base_port=$ROBOT_BASE \
  --robot.id=$ROBOT_ID"

# Add all user arguments (dataset.repo_id, dataset.root, dataset.episode, etc.)
for arg in "$@"; do
    CMD="$CMD $arg"
done

echo "============================================================"
echo "Mimic Robot Dataset Replay"
echo "============================================================"
echo "Robot Config: $CONFIG_FILE"
echo "Robot Type: $ROBOT_TYPE"
echo "Robot ID: $ROBOT_ID"
echo "Left Arm Port: $ROBOT_LEFT_ARM"
echo "Right Arm Port: $ROBOT_RIGHT_ARM"
echo "Base Port: $ROBOT_BASE"
echo "============================================================"
echo ""
echo "Executing: lerobot-replay ..."
echo ""
eval "$CMD"
